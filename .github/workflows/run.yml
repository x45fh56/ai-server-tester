name: Daily VLESS Reality Checker

on:
  schedule:
    - cron: '30 11 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests geoip2

      - name: Debug - Check script file & run
        run: |
          echo "Current directory: $(pwd)"
          ls -la *.py || echo "No .py files in root!"
          cat app.py 2>/dev/null | head -n 15 || echo "app.py not found or cannot read"
          echo "Running script..."
          python -u app.py || echo "Script crashed with code $?"
          echo "After script - folders status:"
          ls -la data/ output/ || echo "Folders missing"

      - name: Commit and push (always attempt)
        if: always()
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          git status

          git add --force output/ data/ || echo "No files to add"

          git diff --staged || echo "No changes detected"

          git commit --allow-empty -m "chore: daily run $(date +'%Y-%m-%d %H:%M UTC') - script output"
          git push || echo "Push skipped"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final log summary
        if: always()
        run: |
          echo "Finished at $(date -u)"
          wc -l output/*.txt 2>/dev/null || echo "No output files generated"
