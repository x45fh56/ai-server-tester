name: Daily VLESS Reality Checker

on:
  schedule:
    - cron: '30 11 * * *'   # 11:30 UTC = 15:00 Iran Time

  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history for accurate git diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests geoip2

      - name: Run VLESS checker script
        run: python app.py  
        
      - name: Debug - List files after script run
        if: always()
        run: |
          echo "Current directory: $(pwd)"
          echo ""
          echo "data/ folder contents:"
          ls -la data/ || echo "data/ not found"
          echo ""
          echo "output/ folder contents:"
          ls -la output/ || echo "output/ not found"
          echo ""
          echo "First few lines of valid_clean.txt:"
          head -n 5 output/1-valid_clean.txt || echo "File not found"
          echo ""
          echo "Geo database size:"
          ls -lh data/GeoLite2-ASN.mmdb || echo "Geo file not found"

      - name: Commit and push all changes (force even if empty)
        if: always()
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          # Show what git sees before adding
          echo "Git status before add:"
          git status

          # Force add all files in output/ and data/
          git add --force output/
          git add --force data/

          # Show diff to debug
          echo "Git diff staged:"
          git diff --staged || echo "No staged changes"

          # Always commit (even empty) to confirm run
          git commit --allow-empty -m "chore: daily vless reality check run - $(date +'%Y-%m-%d %H:%M UTC') (files updated)"

          # Push
          git push || echo "Push skipped (already up-to-date or error)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final summary
        if: always()
        run: |
          echo "========================================"
          echo "Finished at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Clean servers:"
          wc -l output/1-valid_clean.txt 2>/dev/null || echo "No file"
          echo "Reality passed:"
          wc -l output/2-reality_ok.txt 2>/dev/null || echo "No file"
          echo "========================================"
